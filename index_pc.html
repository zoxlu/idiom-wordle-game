<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>成語猜謎遊戲 - 成語 Wordle</title>
  <style>
    :root {
      --bg-color: #121212;
      --board-bg: #181818;
      --tile-border: #e0e0e0;
      --tile-empty-bg: #222;
      --tile-correct: #2e7d32;
      --tile-present: #b38f2b;
      --tile-absent: #424242;
      --text-main: #fafafa;
      --accent: #64b5f6;
      --max-width: 780px;
      --transition-fast: 0.15s ease-out;
      --tile-size: 56px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #1f2933, #050608 60%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .game-container {
      width: 100%;
      max-width: var(--max-width);
      padding: 14px 10px 18px;
      background: rgba(0, 0, 0, 0.72);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
      display: grid;
      grid-template-columns: minmax(210px, 1.1fr) minmax(300px, 1.4fr);
      gap: 14px;
    }

    @media (max-width: 720px) {
      .game-container {
        display: flex;
        flex-direction: column;
        max-width: 100%;
      }
    }

    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-right: 1px solid #1f2937;
      padding-right: 10px;
    }

    @media (max-width: 720px) {
      .left-panel {
        border-right: none;
        border-bottom: 1px solid #1f2937;
        padding-right: 0;
        padding-bottom: 8px;
      }
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      min-height: 310px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .title {
      font-size: 20px;
      letter-spacing: 0.12em;
      font-weight: 700;
    }

    .subtitle {
      font-size: 12px;
      color: #cfcfcf;
    }

    button {
      cursor: pointer;
      border: none;
      outline: none;
      font-family: inherit;
    }

    .btn {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #1e293b;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      background: #334155;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.7);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .board-wrapper {
      background: var(--board-bg);
      border-radius: 14px;
      padding: 10px 8px 14px;
      border: 1px solid #333;
    }

    .board {
      display: grid;
      grid-template-rows: repeat(4, var(--tile-size));
      grid-template-columns: repeat(4, var(--tile-size));
      justify-content: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .tile {
      width: var(--tile-size);
      height: var(--tile-size);
      border-radius: 7px;
      border: 2px solid var(--tile-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      background: var(--tile-empty-bg);
      color: var(--text-main);
      text-align: center;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
      transition: background 0.18s ease-out, border-color 0.18s ease-out, transform 0.08s ease-out;
    }

    .tile.filled {
      border-color: var(--accent);
    }

    .tile.correct {
      background: var(--tile-correct);
      border-color: var(--tile-correct);
      transform: scale(1.02);
    }

    .tile.present {
      background: var(--tile-present);
      border-color: var(--tile-present);
      transform: scale(1.02);
    }

    .tile.absent {
      background: var(--tile-absent);
      border-color: var(--tile-absent);
      color: #bdbdbd;
    }

    .tile.shake {
      animation: shake 0.22s ease-in-out;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: #d1d5db;
    }

    .status-text {
      min-height: 16px;
    }

    .status-text strong { color: #facc15; }

    .attempts {
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      font-weight: 600;
      color: #f97316;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #4b5563;
      font-size: 12px;
      margin-left: 6px;
      color: #e5e7eb;
    }

    .level-progress {
      font-size: 12px;
      color: #e5e7eb;
    }

    .level-progress strong {
      font-size: 14px;
      color: #fbbf24;
    }

    .pool-wrapper {
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px dashed #374151;
    }

    .pool-title {
      font-size: 12px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .char-pool {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px 10px;
      justify-content: center;
    }

    .char-btn {
      padding: 4px 0;
      border-radius: 6px;
      border: 1px solid #9ca3af;
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
      user-select: none;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .char-btn:hover {
      background: #111827;
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.9);
    }

    .char-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .char-btn.used {
      background: #4b5563;
      border-color: #6b7280;
      color: #9ca3af;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .char-btn.absent-global {
      background: #222;
      border-color: #4b5563;
      color: #6b7280;
      cursor: default;
      box-shadow: none;
      transform: none;
      pointer-events: none;
    }

    .char-btn.disabled {
      pointer-events: none;
      opacity: 0.5;
      box-shadow: none;
      transform: none;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 6px;
    }

    .controls-left {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-small {
      padding: 3px 8px;
      font-size: 11px;
    }

    .btn-primary {
      background: #f97316;
      border-color: #ea580c;
      color: white;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(248, 150, 69, 0.7), 0 0 30px rgba(248, 113, 22, 0.7);
    }

    .btn-primary:hover {
      background: #ea580c;
      box-shadow: 0 0 0 1px rgba(248, 150, 69, 0.9), 0 0 38px rgba(248, 113, 22, 0.9);
    }

    .btn-ghost {
      background: transparent;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    .btn-ghost:hover {
      background: #111827;
    }

    .instructions {
      margin-top: 2px;
      padding: 8px 8px 6px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 12px;
      line-height: 1.6;
      color: #e5e7eb;
    }

    .instructions h2 {
      font-size: 13px;
      margin-bottom: 4px;
      color: #f9fafb;
    }

    .instructions ul {
      padding-left: 16px;
    }

    .instructions li + li {
      margin-top: 2px;
    }

    .highlight-correct { color: #4ade80; font-weight: 600; }
    .highlight-present { color: #facc15; font-weight: 600; }

    .toast {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid #4b5563;
      font-size: 12px;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 2px);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .overlay.show {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 14px;
      padding: 16px 14px 12px;
      border: 1px solid #1f2937;
      max-width: 300px;
      width: 92%;
      text-align: center;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.85);
    }

    .modal-title {
      font-size: 16px;
      margin-bottom: 6px;
    }

    .modal-body {
      font-size: 13px;
      margin-bottom: 10px;
      color: #e5e7eb;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 2px;
    }

    .btn-wide {
      min-width: 110px;
      justify-content: center;
    }

    .solved-list {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      max-height: 160px;
      overflow-y: auto;
    }

    .solved-list-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .solved-item {
      line-height: 1.5;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .center-message {
      position: absolute;
      bottom: 18px;
      right: 132px;
      font-size: 20px;
      font-weight: 900;
      color: #ffffff;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 5;
    }

    .center-message.show {
      opacity: 1;
      transform: translateY(-4px);
    }

    .snapshot-controls {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      font-size: 11px;
      align-items: center;
    }

    .snapshot-hint {
      color: #9ca3af;
    }

    @media (max-width: 480px) {
      :root {
        --tile-size: 50px;
      }
      .title { font-size: 18px; }
      .subtitle { font-size: 11px; }
      .char-btn { font-size: 18px; padding: 3px 0; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls > div { display: flex; justify-content: space-between; }
      .center-message { font-size: 18px; right: 120px; bottom: 22px; }
      .snapshot-controls { flex-direction: column; align-items: flex-start; }
    }

    .btn-undo-icon {
      font-size: 18px;
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <div class="overlay" id="end-overlay">
    <div class="modal">
      <div class="modal-title" id="end-title"></div>
      <div class="modal-body" id="end-body"></div>
      <div class="modal-actions">
        <button class="btn btn-primary btn-wide" id="btn-retry">再玩一次</button>
      </div>
    </div>
  </div>

  <div class="game-container">
    <div class="left-panel">
      <div class="header">
        <div>
          <div class="title">成語猜謎</div>
          <div class="subtitle">四字成語版 Wordle</div>
        </div>
      </div>

      <div class="instructions">
        <h2>遊戲說明</h2>
        <ul>
          <li>從下方 20 個字中選出 <strong>4 個</strong>，依序填入上方空格後按「送出答案」。</li>
          <li><span class="highlight-correct">綠色</span>：字與<strong>位置</strong>都正確；<span class="highlight-present">土黃色</span>：字在成語中但<strong>位置不對</strong>；灰色：不在答案中。</li>
        </ul>
        <div class="snapshot-controls">
          <span class="snapshot-hint">每題作答會自動拍成 jpg 圖片，遊戲結束後可下載作答紀錄。</span>
          <button class="btn btn-small btn-ghost" id="btn-download-snaps" disabled>下載作答紀錄</button>
        </div>
      </div>

      <div class="solved-list" id="solved-list">
        <div class="solved-list-title">已猜對的成語</div>
        <div id="solved-items"></div>
      </div>
    </div>

    <div class="right-panel" id="right-panel">
      <div class="board-wrapper" id="board-wrapper">
        <div class="info-row">
          <div class="status-text" id="status-text"></div>
          <div class="attempts" id="attempts-text"></div>
        </div>

        <div class="info-row" style="margin-bottom: 6px;">
          <div>
            等級：
            <span class="level-badge" id="level-badge">小學生</span>
          </div>
          <div class="level-progress">本級已答對 <strong id="level-correct">0</strong> / 5 題</div>
        </div>

        <div class="board" id="board"></div>
        <div class="center-message" id="center-message">正確答案</div>

        <div class="pool-wrapper">
          <div class="pool-title">請用滑鼠點選下方文字，依順序填入上方空格：</div>
          <div class="char-pool" id="char-pool"></div>
        </div>

        <div class="controls">
          <div class="controls-left">
            <button class="btn btn-small btn-ghost" id="btn-undo"><span class="btn-undo-icon">⌫</span> 倒退一格</button>
          </div>
          <div>
            <button class="btn btn-primary" id="btn-submit">送出答案</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LEVELS = [
      { key: 'elementary', name: '小學生' },
      { key: 'general', name: '普羅大眾' },
      { key: 'teacher', name: '國文老師' },
      { key: 'professor', name: '中文系教授' }
    ];

    const ROWS = 4;
    const COLS = 4;

    const boardEl = document.getElementById('board');
    const poolEl = document.getElementById('char-pool');
    const statusTextEl = document.getElementById('status-text');
    const attemptsTextEl = document.getElementById('attempts-text');
    const toastEl = document.getElementById('toast');
    const levelBadgeEl = document.getElementById('level-badge');
    const levelCorrectEl = document.getElementById('level-correct');
    const endOverlayEl = document.getElementById('end-overlay');
    const endTitleEl = document.getElementById('end-title');
    const endBodyEl = document.getElementById('end-body');
    const rightPanelEl = document.getElementById('right-panel');
    const boardWrapperEl = document.getElementById('board-wrapper');
    const solvedItemsEl = document.getElementById('solved-items');
    const centerMessageEl = document.getElementById('center-message');
    const btnDownloadSnaps = document.getElementById('btn-download-snaps');

    const btnSubmit = document.getElementById('btn-submit');
    const btnUndo = document.getElementById('btn-undo');
    const btnRetry = document.getElementById('btn-retry');

    let ALL_CHARS = '';
    let idiomData = null;

    let answer = '';
    let currentRow = 0;
    let currentCol = 0;
    let boardState = [];
    let gameOver = false;
    let waitingForClickToContinue = false;

    let currentLevelIndex = 0;
    let levelCorrectCount = 0;
    let solvedIdioms = [];

    let snapshots = [];
    let snapshotZipBlob = null;

    function showToast(msg, duration = 1500) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, duration);
    }

    function openEndOverlay(title, body) {
      endTitleEl.textContent = title;
      endBodyEl.textContent = body;
      endOverlayEl.classList.add('show');
    }

    function closeEndOverlay() {
      endOverlayEl.classList.remove('show');
    }

    function initBoard() {
      boardEl.innerHTML = '';
      boardState = Array.from({ length: ROWS }, () => Array(COLS).fill(''));
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const div = document.createElement('div');
          div.className = 'tile';
          div.dataset.row = r;
          div.dataset.col = c;
          boardEl.appendChild(div);
        }
      }
    }

    function updateAttemptsText() {
      attemptsTextEl.textContent = '';
    }

    function updateLevelUI() {
      levelBadgeEl.textContent = LEVELS[currentLevelIndex].name;
      levelCorrectEl.textContent = levelCorrectCount;
    }

    function getCurrentLevelBucket() {
      if (!idiomData || !idiomData.levels) return [];
      const levelKey = LEVELS[currentLevelIndex].key;
      const bucket = idiomData.levels[levelKey] || [];
      return bucket;
    }

    function pickRandomIdiom() {
      const bucket = getCurrentLevelBucket();
      if (!bucket.length) {
        console.warn('題庫為空或尚未載入，無法選題');
        return '';
      }
      const usedSet = new Set(solvedIdioms);
      const available = bucket.filter(i => !usedSet.has(i));
      const pool = available.length > 0 ? available : bucket;
      const idx = Math.floor(Math.random() * pool.length);
      return pool[idx];
    }

    function getAllCharsPool() {
      if (ALL_CHARS && ALL_CHARS.length) return ALL_CHARS;
      if (!idiomData || !idiomData.levels) return '';
      const all = [];
      Object.values(idiomData.levels).forEach(list => {
        list.forEach(idiom => {
          idiom.split('').forEach(ch => all.push(ch));
        });
      });
      ALL_CHARS = Array.from(new Set(all)).join('');
      return ALL_CHARS;
    }

    async function loadRandomCharsFromFile() {
      try {
        const res = await fetch('random.json');
        if (!res.ok) throw new Error('載入 random.json 失敗');
        const data = await res.json();
        if (Array.isArray(data.randomChars)) {
          ALL_CHARS = Array.from(new Set(data.randomChars.join(''))).join('');
        }
      } catch (e) {
        console.warn('使用題庫自帶字庫作為後備方案：', e);
        getAllCharsPool();
      }
    }

    function getRandomChars(n, excludeChars) {
      const pool = Array.from(new Set(ALL_CHARS.split('').filter(ch => !excludeChars.includes(ch))));
      const result = [];
      for (let i = 0; i < n && pool.length > 0; i++) {
        const idx = Math.floor(Math.random() * pool.length);
        result.push(pool[idx]);
        pool.splice(idx, 1);
      }
      return result;
    }

    function buildCharPool() {
      poolEl.innerHTML = '';
      const ansChars = answer.split('');
      const randomChars = getRandomChars(16, ansChars);
      let chars = ansChars.concat(randomChars);
      for (let i = chars.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [chars[i], chars[j]] = [chars[j], chars[i]];
      }
      chars.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.className = 'char-btn';
        btn.textContent = ch;
        btn.dataset.char = ch;
        btn.dataset.index = idx;
        btn.addEventListener('click', () => onCharClick(ch, btn));
        poolEl.appendChild(btn);
      });
    }

    function setInputEnabled(enabled) {
      const charButtons = poolEl.querySelectorAll('.char-btn');
      charButtons.forEach(btn => {
        if (enabled) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
      btnUndo.disabled = !enabled;
    }

    function getCharButtonsByChar(ch) {
      return Array.from(poolEl.querySelectorAll(`.char-btn[data-char="${ch}"]`));
    }

    function markAbsentChars(guess) {
      const answerChars = answer.split('');

      const remaining = {};
      answerChars.forEach((ch, i) => {
        const g = guess[i];
        if (g === ch) {
        } else {
          remaining[ch] = (remaining[ch] || 0) + 1;
        }
      });

      const usedCount = {};
      for (let i = 0; i < COLS; i++) {
        const ch = guess[i];
        if (!answerChars.includes(ch)) {
          const buttons = getCharButtonsByChar(ch);
          buttons.forEach(btn => btn.classList.add('absent-global'));
        } else {
          usedCount[ch] = (usedCount[ch] || 0) + 1;
          if (!remaining[ch] && guess[i] !== answerChars[i]) {
            const buttons = getCharButtonsByChar(ch);
            buttons.forEach(btn => btn.classList.add('used'));
          }
        }
      }
    }

    function onCharClick(ch, btn) {
      if (gameOver || waitingForClickToContinue) return;
      if (btn.classList.contains('used') || btn.classList.contains('disabled') || btn.classList.contains('absent-global')) return;
      if (currentCol >= COLS) {
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        showToast('本列已填滿 4 個字，請先送出或刪除。');
        return;
      }
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = ch;
      tile.classList.add('filled');
      boardState[currentRow][currentCol] = ch;
      currentCol++;
    }

    function getRowTiles(row) {
      return Array.from(boardEl.querySelectorAll(`.tile[data-row="${row}"]`));
    }

    function undoChar() {
      if (gameOver || waitingForClickToContinue) return;
      if (currentCol === 0) {
        showToast('本列沒有可以刪除的字。');
        return;
      }
      currentCol--;
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = '';
      tile.classList.remove('filled');
      boardState[currentRow][currentCol] = '';
    }

    function colorRow(row, guess) {
      const tiles = getRowTiles(row);
      const answerChars = answer.split('');
      const result = Array(COLS).fill('absent');

      const remaining = {};
      answerChars.forEach((ch, i) => {
        if (guess[i] === ch) {
          result[i] = 'correct';
        } else {
          remaining[ch] = (remaining[ch] || 0) + 1;
        }
      });

      for (let i = 0; i < COLS; i++) {
        if (result[i] === 'correct') continue;
        const ch = guess[i];
        if (remaining[ch] > 0) {
          result[i] = 'present';
          remaining[ch]--;
        }
      }

      tiles.forEach((tile, i) => {
        tile.classList.remove('filled', 'correct', 'present', 'absent');
        tile.classList.add(result[i]);
      });

      markAbsentChars(guess);
    }

    function addSolvedIdiom(idiom, levelName) {
      solvedIdioms.push(idiom);
      const item = document.createElement('div');
      item.className = 'solved-item';
      item.textContent = `${idiom}（${levelName}）`;
      solvedItemsEl.prepend(item);
      if (solvedItemsEl.children.length > 20) {
        solvedItemsEl.removeChild(solvedItemsEl.lastChild);
      }
    }

    function showCenterMessage() {
      centerMessageEl.classList.add('show');
    }

    function hideCenterMessage() {
      centerMessageEl.classList.remove('show');
    }

    function enterNextQuestionMode() {
      waitingForClickToContinue = true;
      setInputEnabled(false);
      showCenterMessage();
      btnSubmit.textContent = '下一題';
    }

    function exitNextQuestionMode() {
      waitingForClickToContinue = false;
      hideCenterMessage();
      setInputEnabled(true);
      btnSubmit.textContent = '送出答案';
    }

    async function takeSnapshotForCurrentQuestion(indexForName) {
      if (typeof html2canvas === 'undefined') {
        console.warn('html2canvas 尚未載入，無法截圖');
        return;
      }
      try {
        const canvas = await html2canvas(boardWrapperEl, {
          backgroundColor: '#000000',
          scale: window.devicePixelRatio || 1
        });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
        if (blob) {
          const filename = `idiom_round_${String(indexForName).padStart(2, '0')}.jpg`;
          snapshots.push({ name: filename, blob });
          snapshotZipBlob = null;
          btnDownloadSnaps.disabled = false;
        }
      } catch (e) {
        console.error('截圖失敗', e);
      }
    }

    function clearSnapshots() {
      snapshots = [];
      snapshotZipBlob = null;
      btnDownloadSnaps.disabled = true;
    }

    async function downloadAllSnapshots() {
      if (!snapshots.length) return;

      if (!snapshotZipBlob) {
        if (typeof JSZip === 'undefined') {
          showToast('壓縮元件尚未載入，請稍後再試。', 2000);
          return;
        }
        const zip = new JSZip();
        const imgFolder = zip.folder('idiom_snapshots');
        snapshots.forEach((snap, idx) => {
          const filename = snap.name || `idiom_round_${idx + 1}.jpg`;
          imgFolder.file(filename, snap.blob);
        });
        try {
          snapshotZipBlob = await zip.generateAsync({ type: 'blob' });
        } catch (e) {
          console.error('建立 zip 失敗', e);
          showToast('建立壓縮檔時發生錯誤，請再試一次。', 2000);
          return;
        }
      }

      const url = URL.createObjectURL(snapshotZipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'idiom_snapshots.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function handleCorrectAnswer() {
      levelCorrectCount++;
      addSolvedIdiom(answer, LEVELS[currentLevelIndex].name);

      takeSnapshotForCurrentQuestion(solvedIdioms.length);

      const finishedAllLevels = (currentLevelIndex === LEVELS.length - 1 && levelCorrectCount >= 5);
      if (finishedAllLevels) {
        updateLevelUI();
        statusTextEl.textContent = '';
        gameOver = true;
        showCenterMessage();
        btnSubmit.disabled = true;
        setInputEnabled(false);
        openEndOverlay('恭喜！你是成語達人', '點擊「再玩一次」可重新開始新遊戲。');
        return;
      }

      if (levelCorrectCount >= 5) {
        currentLevelIndex++;
        levelCorrectCount = 0;
        showToast(`升級到「${LEVELS[currentLevelIndex].name}」！`, 2000);
      }

      updateLevelUI();
      statusTextEl.textContent = '';
      enterNextQuestionMode();
    }

    function submitRow() {
      if (gameOver) return;

      if (waitingForClickToContinue) {
        exitNextQuestionMode();
        newRound();
        return;
      }

      if (currentCol < COLS) {
        showToast('請先填滿四個字再送出。');
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        return;
      }

      const guess = boardState[currentRow].join('');
      colorRow(currentRow, guess);

      if (guess === answer) {
        handleCorrectAnswer();
        return;
      }

      currentRow++;
      if (currentRow >= ROWS) {
        gameOver = true;
        statusTextEl.textContent = `Game Over，正確答案是：${answer}`;
        openEndOverlay('Game Over', '再玩一次，挑戰更多成語吧！');
      } else {
        currentCol = 0;
        updateAttemptsText();
      }
    }

    function newRound() {
      answer = pickRandomIdiom();
      if (!answer) {
        statusTextEl.textContent = '題庫尚未載入完成，請稍後再試。';
        return;
      }
      currentRow = 0;
      currentCol = 0;
      gameOver = false;
      hideCenterMessage();
      statusTextEl.textContent = '';
      initBoard();
      buildCharPool();
      updateAttemptsText();
      btnSubmit.disabled = false;
    }

    function restartGame() {
      currentLevelIndex = 0;
      levelCorrectCount = 0;
      solvedIdioms = [];
      solvedItemsEl.innerHTML = '';
      closeEndOverlay();
      updateLevelUI();
      exitNextQuestionMode();
      clearSnapshots();
      newRound();
    }

    async function loadIdiomData() {
      try {
        const res = await fetch('data/wordle_game_data.json');
        if (!res.ok) throw new Error('載入題庫失敗');
        idiomData = await res.json();
        await loadRandomCharsFromFile();
        if (!ALL_CHARS) {
          getAllCharsPool();
        }
        newRound();
      } catch (e) {
        console.error(e);
        statusTextEl.textContent = '無法載入題庫，請確認 wordle_game_data.json 是否存在。';
      }
    }

    btnSubmit.addEventListener('click', submitRow);
    btnUndo.addEventListener('click', undoChar);
    btnRetry.addEventListener('click', () => {
      restartGame();
    });

    btnDownloadSnaps.addEventListener('click', () => {
      downloadAllSnapshots();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitRow();
      } else if (e.key === 'Backspace') {
        e.preventDefault();
        undoChar();
      }
    });

    rightPanelEl.addEventListener('click', () => {
    });

    updateLevelUI();
    clearSnapshots();
    loadIdiomData();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
