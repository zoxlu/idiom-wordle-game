<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>成語猜謎遊戲 - 手機版</title>
  <style>
    :root {
      --bg-color: #020617;
      --board-bg: #020617;
      --tile-border: #e0e0e0;
      --tile-empty-bg: #020617;
      --tile-correct: #16a34a;
      --tile-present: #eab308;
      --tile-absent: #4b5563;
      --text-main: #f9fafb;
      --accent: #fb923c;
      --transition-fast: 0.15s ease-out;
      --tile-size: 64px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overscroll-behavior: none;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #1f2933, #020617 60%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      touch-action: manipulation;
    }

    .game-shell {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: #020617;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-bar {
      padding: 10px 14px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .title-group {
      display: flex;
      flex-direction: column;
    }

    .title {
      font-size: 18px;
      letter-spacing: 0.16em;
      font-weight: 700;
    }

    .subtitle {
      font-size: 11px;
      color: #cbd5f5;
      margin-top: 2px;
    }

    .top-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: none;
      outline: none;
      font-family: inherit;
    }

    .btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #0f172a;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    }

    .btn:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: #f97316;
      border-color: #ea580c;
      color: white;
      padding: 9px 16px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(248, 150, 69, 0.6), 0 0 16px rgba(248, 113, 22, 0.8);
    }

    .btn-ghost {
      background: transparent;
      border-color: #4b5563;
      color: #e5e7eb;
      padding-inline: 10px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 11px;
    }

    .btn-wide {
      min-width: 140px;
      justify-content: center;
    }

    .btn-undo-icon {
      font-size: 18px;
      line-height: 1;
    }

    .main-panel {
      flex: 1;
      padding: 10px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    .board-wrapper {
      background: var(--board-bg);
      border-radius: 16px;
      padding: 8px 10px 10px;
      border: 1px solid #1f2937;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.85);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 70px);
      max-height: 720px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .status-text {
      min-height: 14px;
      font-size: 11px;
      font-weight: 700;
      transition: transform 0.25s ease-out, color 0.25s ease-out, font-size 0.25s ease-out;
    }

    .status-text strong {
      color: #facc15;
    }

    .status-text.level-up {
      color: #fb923c;
      font-size: 12px;
      font-weight: 800;
      transform: scale(1.02);
    }

    .attempts {
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      font-weight: 600;
      color: #f97316;
    }

    .info-row-secondary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 9px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid #4b5563;
      font-size: 12px;
      color: #e5e7eb;
    }

    .level-progress {
      font-size: 12px;
      color: #e5e7eb;
    }

    .level-progress strong {
      font-size: 14px;
      color: #fbbf24;
    }

    .board {
      display: grid;
      grid-template-rows: repeat(4, minmax(0, 1fr));
      grid-template-columns: repeat(4, minmax(0, 1fr));
      justify-content: center;
      gap: 4px;
      margin-bottom: 4px;
      flex: 0 0 34%;
    }

    .tile {
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      border: 2px solid var(--tile-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(20px, 4.8vw, 26px);
      font-weight: 700;
      background: var(--tile-empty-bg);
      color: var(--text-main);
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      transition: background 0.18s ease-out, border-color 0.18s ease-out, transform 0.08s ease-out;
    }

    .tile.filled {
      border-color: var(--accent);
    }

    .tile.correct {
      background: var(--tile-correct);
      border-color: var(--tile-correct);
      transform: scale(1.03);
    }

    .tile.present {
      background: var(--tile-present);
      border-color: var(--tile-present);
      transform: scale(1.03);
    }

    .tile.absent {
      background: var(--tile-absent);
      border-color: var(--tile-absent);
      color: #e5e7eb;
    }

    .tile.shake {
      animation: shake 0.22s ease-in-out;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    .pool-wrapper {
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px dashed #334155;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .pool-title {
      font-size: 11px;
      margin-bottom: 4px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .char-pool {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px 8px;
      justify-content: center;
      flex: 1 1 auto;
      align-content: start;
    }

    .char-btn {
      padding: 6px 0;
      border-radius: 10px;
      border: 1px solid #9ca3af;
      background: radial-gradient(circle at top, #0f172a, #020617 70%);
      color: #f9fafb;
      font-size: clamp(18px, 4.6vw, 22px);
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), opacity var(--transition-fast);
      user-select: none;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .char-btn:active {
      transform: scale(0.96);
      box-shadow: none;
    }

    .char-btn.used {
      background: #4b5563;
      border-color: #6b7280;
      color: #9ca3af;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .char-btn.absent-global {
      background: #020617;
      border-color: #4b5563;
      color: #6b7280;
      cursor: default;
      box-shadow: none;
      transform: none;
      pointer-events: none;
    }

    .char-btn.disabled {
      pointer-events: none;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 8px;
      flex-wrap: wrap;
      flex-shrink: 0;
      padding-top: 4px;
      border-top: 1px dashed #334155;
    }

    .controls-left {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
    }

    .controls-right {
      display: flex;
      justify-content: flex-end;
      flex: 1;
    }

    .center-message {
      text-align: center;
      font-size: 18px;
      font-weight: 900;
      color: #f97316;
      margin-top: 4px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      pointer-events: none;
    }

    .center-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid #4b5563;
      font-size: 12px;
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 2px);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .overlay.show {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 16px;
      padding: 18px 16px 14px;
      border: 1px solid #1f2937;
      max-width: 360px;
      width: 92%;
      text-align: left;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.85);
    }

    .modal-title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 10px;
      text-align: center;
    }

    .modal-body {
      font-size: 15px;
      margin-bottom: 12px;
      color: #e5e7eb;
      line-height: 1.8;
    }

    .modal-body ul {
      padding-left: 18px;
      margin-top: 4px;
    }

    .modal-body li + li {
      margin-top: 3px;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .highlight-correct { color: #4ade80; font-weight: 600; }
    .highlight-present { color: #facc15; font-weight: 600; }

    .modal-share-certificate {
      background: rgba(2, 6, 23, 0.9);
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px dashed #f97316;
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
      position: relative;
      overflow: hidden;
    }

    .modal-share-certificate::before,
    .modal-share-certificate::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(251, 191, 36, 0.4);
      pointer-events: none;
    }

    .modal-share-certificate::before {
      inset: 3px;
    }

    .modal-share-certificate::after {
      inset: 6px;
      border-style: dotted;
      opacity: 0.6;
    }

    .modal-share-certificate h4 {
      margin-bottom: 4px;
      font-size: 13px;
      color: #fbbf24;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    .modal-share-certificate p {
      position: relative;
      z-index: 1;
    }

    /* 橫向螢幕不支援提示 */
    .orientation-overlay {
      position: fixed;
      inset: 0;
      background: #020617;
      color: #e5e7eb;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      z-index: 50;
    }

    .orientation-overlay.show {
      display: flex;
    }

    .orientation-message {
      max-width: 320px;
      font-size: 16px;
      line-height: 1.7;
      font-weight: 600;
    }

    @media (max-width: 400px) {
      :root {
        --tile-size: 56px;
      }
      .title { font-size: 16px; }
      .char-btn { font-size: 18px; min-height: 40px; }
      .main-panel { padding-inline: 8px; }
    }

    @media (max-height: 640px) {
      .board-wrapper {
        padding-block: 6px;
        height: calc(100vh - 60px);
      }
      .board {
        flex-basis: 30%;
      }
      .char-btn {
        min-height: 40px;
      }
    }

    @media (min-width: 768px) and (min-height: 700px) {
      body {
        align-items: center;
      }
      .game-shell {
        max-height: 720px;
      }
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <div class="overlay" id="end-overlay">
    <div class="modal">
      <div class="modal-title" id="end-title"></div>
      <div class="modal-body" id="end-body"></div>
      <div class="modal-actions" id="end-actions">
        <button class="btn btn-primary btn-wide" id="btn-retry">再玩一次</button>
      </div>
    </div>
  </div>

  <div class="overlay show" id="start-overlay">
    <div class="modal">
      <div class="modal-title">成語猜謎</div>
      <div class="modal-body">
        <p>四字成語版 Wordle，適合在手機上動動腦的猜成語小遊戲。</p>
        <ul>
          <li>從下方 16 個字中選出 <strong>4 個</strong>，依序填入上方空格後按「送出答案」。</li>
          <li><span class="highlight-correct">綠色</span>：字和<strong>位置</strong>都正確；<span class="highlight-present">土黃色</span>：字在成語中但<strong>位置不對</strong>；灰色：不在答案中。</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost btn-small" id="btn-start-rules">遊戲規則</button>
        <button class="btn btn-primary btn-wide" id="btn-start-game">開始遊戲</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="rules-overlay">
    <div class="modal">
      <div class="modal-title">遊戲規則</div>
      <div class="modal-body">
        <p>每一題的目標是猜出一個四字成語：</p>
        <ul>
          <li>從畫面下方 16 個字中選出 <strong>4 個</strong>，依順序填進上方 4 個格子。</li>
          <li>填滿後按「送出答案」，系統會用顏色給你提示。</li>
          <li><span class="highlight-correct">綠色</span>：字和<strong>位置</strong>都正確。</li>
          <li><span class="highlight-present">土黃色</span>：字有出現在答案中，但<strong>位置不對</strong>。</li>
          <li>灰色：這個字沒有出現在答案中。</li>
        </ul>
        <p style="margin-top:6px;">連續答對多題可以升級，挑戰更困難的成語！</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost btn-wide" id="btn-close-rules">關閉</button>
      </div>
    </div>
  </div>

  <div class="game-shell">
    <header class="top-bar">
      <div class="title-group">
        <div class="title">成語猜謎</div>
        <div class="subtitle">四字成語版 Wordle</div>
      </div>
      <div class="top-actions">
        <button class="btn btn-small btn-ghost" id="btn-open-rules">遊戲規則</button>
      </div>
    </header>

    <main class="main-panel">
      <section class="board-wrapper" id="board-wrapper">
        <div class="info-row">
          <div class="instructions-text">請從下方選字，依序填入上方空格：</div>
          <div class="attempts" id="attempts-text"></div>
        </div>

        <div class="info-row-secondary">
          <div>
            等級：
            <span class="level-badge" id="level-badge">小學生</span>
          </div>
          <div class="level-progress">本級已答對 <strong id="level-correct">0</strong> 題</div>
        </div>

        <div class="status-text" id="status-text"></div>

        <div class="board" id="board"></div>
        <div class="center-message" id="center-message">正確答案</div>

        <div class="pool-wrapper">
          <div class="pool-title">請點選下方文字，依順序填入上方空格：</div>
          <div class="char-pool" id="char-pool"></div>
        </div>

        <div class="controls">
          <div class="controls-left">
            <button class="btn btn-small btn-ghost" id="btn-undo"><span class="btn-undo-icon">⌫</span> 倒退一格</button>
          </div>
          <div class="controls-right">
            <button class="btn btn-primary" id="btn-submit">送出答案</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="orientation-overlay" id="orientation-overlay">
    <div class="orientation-message">遊戲顯示不支援橫向螢幕，請將手機轉回直立。</div>
  </div>

  <canvas id="share-canvas" width="600" height="450" style="display:none;"></canvas>

  <script>
    const LEVELS = [
      { key: 'elementary', name: '小學生' },
      { key: 'general', name: '普羅大眾' },
      { key: 'teacher', name: '國文老師' },
      { key: 'professor', name: '中文系教授' }
    ];

    const ROWS = 4;
    const COLS = 4;

    const boardEl = document.getElementById('board');
    const poolEl = document.getElementById('char-pool');
    const statusTextEl = document.getElementById('status-text');
    const attemptsTextEl = document.getElementById('attempts-text');
    const toastEl = document.getElementById('toast');
    const levelBadgeEl = document.getElementById('level-badge');
    const levelCorrectEl = document.getElementById('level-correct');
    const endOverlayEl = document.getElementById('end-overlay');
    const endTitleEl = document.getElementById('end-title');
    const endBodyEl = document.getElementById('end-body');
    const boardWrapperEl = document.getElementById('board-wrapper');
    const centerMessageEl = document.getElementById('center-message');

    const startOverlayEl = document.getElementById('start-overlay');
    const rulesOverlayEl = document.getElementById('rules-overlay');
    const btnStartGame = document.getElementById('btn-start-game');
    const btnStartRules = document.getElementById('btn-start-rules');
    const btnOpenRules = document.getElementById('btn-open-rules');
    const btnCloseRules = document.getElementById('btn-close-rules');

    const btnSubmit = document.getElementById('btn-submit');
    const btnUndo = document.getElementById('btn-undo');
    const btnRetry = document.getElementById('btn-retry');
    const endActionsEl = document.getElementById('end-actions');

    const shareCanvas = document.getElementById('share-canvas');
    const orientationOverlay = document.getElementById('orientation-overlay');

    let ALL_CHARS = '';
    let idiomData = null;

    let answer = '';
    let currentRow = 0;
    let currentCol = 0;
    let boardState = [];
    let gameOver = false;
    let waitingForClickToContinue = false;

    let currentLevelIndex = 0;
    let levelCorrectCount = 0;
    let solvedIdioms = [];

    let totalQuestions = 0;
    let totalCorrect = 0;

    function showToast(msg, duration = 1500) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, duration);
    }

    function openEndOverlay(title, bodyHtml, showShare = false, allCleared = false, isWrongAnswer = false) {
      endTitleEl.textContent = title;
      endBodyEl.innerHTML = bodyHtml;

      endActionsEl.innerHTML = '';

      if (showShare && !isWrongAnswer) {
        const btnShare = document.createElement('button');
        btnShare.className = 'btn btn-ghost btn-wide';
        btnShare.textContent = '分享';
        btnShare.id = 'btn-share';
        btnShare.addEventListener('click', async () => {
          try {
            const url = await generateCertificateImage();
            if (navigator.share) {
              try {
                const res = await fetch(url);
                const blob = await res.blob();
                const file = new File([blob], 'chengyu-wordle-certificate.png', { type: 'image/png' });
                await navigator.share({
                  files: [file],
                  title: '成語 Wordle 證書',
                  text: '我的成語能力認證卡'
                });
              } catch (err) {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'chengyu-wordle-certificate.png';
                link.click();
                showToast('成語 Wordle 證書，可手動分享或儲存。', 2500);
              }
            } else {
              const link = document.createElement('a');
              link.href = url;
              link.download = 'chengyu-wordle-certificate.png';
              link.click();
              showToast('成語 Wordle 證書，可手動分享或儲存。', 2500);
            }
          } catch (err) {
            console.error(err);
            showToast('產生證書圖片時發生錯誤。', 2000);
          }
        });
        endActionsEl.appendChild(btnShare);
      }

      const btnRetryClone = btnRetry.cloneNode(true);
      btnRetryClone.id = 'btn-retry';
      btnRetryClone.addEventListener('click', () => {
        restartGame();
        hideStartOverlay();
      });
      endActionsEl.appendChild(btnRetryClone);

      if (allCleared && !isWrongAnswer) {
        const extra = document.createElement('div');
        extra.className = 'modal-share-certificate';
        extra.innerHTML = '<h4>恭喜破關！</h4><p>你已完成所有等級的成語挑戰，快用上方「分享」按鈕，把你的成就秀給朋友看吧！</p>';
        endBodyEl.appendChild(extra);
      }

      endOverlayEl.classList.add('show');
    }

    function closeEndOverlay() {
      endOverlayEl.classList.remove('show');
    }

    function showStartOverlay() {
      startOverlayEl.classList.add('show');
    }

    function hideStartOverlay() {
      startOverlayEl.classList.remove('show');
    }

    function showRulesOverlay() {
      rulesOverlayEl.classList.add('show');
    }

    function hideRulesOverlay() {
      rulesOverlayEl.classList.remove('show');
    }

    function initBoard() {
      boardEl.innerHTML = '';
      boardState = Array.from({ length: ROWS }, () => Array(COLS).fill(''));
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const div = document.createElement('div');
          div.className = 'tile';
          div.dataset.row = r;
          div.dataset.col = c;
          boardEl.appendChild(div);
        }
      }
    }

    function updateAttemptsText() {
      attemptsTextEl.textContent = '';
    }

    function getCurrentLevelName() {
      return LEVELS[currentLevelIndex].name;
    }

    function updateLevelUI() {
      levelBadgeEl.textContent = LEVELS[currentLevelIndex].name;
      levelCorrectEl.textContent = levelCorrectCount;
    }

    function getCurrentLevelBucket() {
      if (!idiomData || !idiomData.levels) return [];
      const levelKey = LEVELS[currentLevelIndex].key;
      const bucket = idiomData.levels[levelKey] || [];
      return bucket;
    }

    function pickRandomIdiom() {
      const bucket = getCurrentLevelBucket();
      if (!bucket.length) {
        console.warn('題庫為空或尚未載入，無法選題');
        return '';
      }
      const usedSet = new Set(solvedIdioms);
      const available = bucket.filter(i => !usedSet.has(i));
      const pool = available.length > 0 ? available : bucket;
      const idx = Math.floor(Math.random() * pool.length);
      return pool[idx];
    }

    function getAllCharsPool() {
      if (ALL_CHARS && ALL_CHARS.length) return ALL_CHARS;
      if (!idiomData || !idiomData.levels) return '';
      const all = [];
      Object.values(idiomData.levels).forEach(list => {
        list.forEach(idiom => {
          idiom.split('').forEach(ch => all.push(ch));
        });
      });
      ALL_CHARS = Array.from(new Set(all)).join('');
      return ALL_CHARS;
    }

    async function loadRandomCharsFromFile() {
      try {
        const res = await fetch('random.json');
        if (!res.ok) throw new Error('載入 random.json 失敗');
        const data = await res.json();
        if (Array.isArray(data.randomChars)) {
          ALL_CHARS = Array.from(new Set(data.randomChars.join(''))).join('');
        }
      } catch (e) {
        console.warn('使用題庫自帶字庫作為備援方案：', e);
        getAllCharsPool();
      }
    }

    function getRandomChars(n, excludeChars) {
      const pool = Array.from(new Set(ALL_CHARS.split('').filter(ch => !excludeChars.includes(ch))));
      const result = [];
      for (let i = 0; i < n && pool.length > 0; i++) {
        const idx = Math.floor(Math.random() * pool.length);
        result.push(pool[idx]);
        pool.splice(idx, 1);
      }
      return result;
    }

    function buildCharPool() {
      poolEl.innerHTML = '';
      const ansChars = answer.split('');
      const randomChars = getRandomChars(12, ansChars);
      let chars = ansChars.concat(randomChars);
      for (let i = chars.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [chars[i], chars[j]] = [chars[j], chars[i]];
      }
      chars.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.className = 'char-btn';
        btn.textContent = ch;
        btn.dataset.char = ch;
        btn.dataset.index = idx;
        btn.addEventListener('click', () => onCharClick(ch, btn));
        poolEl.appendChild(btn);
      });
    }

    function setInputEnabled(enabled) {
      const charButtons = poolEl.querySelectorAll('.char-btn');
      charButtons.forEach(btn => {
        if (enabled) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
      btnUndo.disabled = !enabled;
    }

    function getCharButtonsByChar(ch) {
      return Array.from(poolEl.querySelectorAll(`.char-btn[data-char="${ch}"]`));
    }

    function markAbsentChars(guess) {
      const answerChars = answer.split('');

      const remaining = {};
      answerChars.forEach((ch, i) => {
        const g = guess[i];
        if (g === ch) {
        } else {
          remaining[ch] = (remaining[ch] || 0) + 1;
        }
      });

      const usedCount = {};
      for (let i = 0; i < COLS; i++) {
        const ch = guess[i];
        if (!answerChars.includes(ch)) {
          const buttons = getCharButtonsByChar(ch);
          buttons.forEach(btn => btn.classList.add('absent-global'));
        } else {
          usedCount[ch] = (usedCount[ch] || 0) + 1;
          if (!remaining[ch] && guess[i] !== answerChars[i]) {
            const buttons = getCharButtonsByChar(ch);
            buttons.forEach(btn => btn.classList.add('used'));
          }
        }
      }
    }

    function onCharClick(ch, btn) {
      if (gameOver || waitingForClickToContinue) return;
      if (btn.classList.contains('used') || btn.classList.contains('disabled') || btn.classList.contains('absent-global')) return;
      if (currentCol >= COLS) {
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        showToast('本列已填滿 4 個字，請先送出或刪除。');
        return;
      }
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = ch;
      tile.classList.add('filled');
      boardState[currentRow][currentCol] = ch;
      currentCol++;
    }

    function getRowTiles(row) {
      return Array.from(boardEl.querySelectorAll(`.tile[data-row="${row}"]`));
    }

    function undoChar() {
      if (gameOver || waitingForClickToContinue) return;
      if (currentCol === 0) {
        showToast('本列沒有可以刪除的字。');
        return;
      }
      currentCol--;
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = '';
      tile.classList.remove('filled');
      boardState[currentRow][currentCol] = '';
    }

    function colorRow(row, guess) {
      const tiles = getRowTiles(row);
      const answerChars = answer.split('');
      const result = Array(COLS).fill('absent');

      const remaining = {};
      answerChars.forEach((ch, i) => {
        if (guess[i] === ch) {
          result[i] = 'correct';
        } else {
          remaining[ch] = (remaining[ch] || 0) + 1;
        }
      });

      for (let i = 0; i < COLS; i++) {
        if (result[i] === 'correct') continue;
        const ch = guess[i];
        if (remaining[ch] > 0) {
          result[i] = 'present';
          remaining[ch]--;
        }
      }

      tiles.forEach((tile, i) => {
        tile.classList.remove('filled', 'correct', 'present', 'absent');
        tile.classList.add(result[i]);
      });

      markAbsentChars(guess);
    }

    function showCenterMessage() {
      centerMessageEl.classList.add('show');
    }

    function hideCenterMessage() {
      centerMessageEl.classList.remove('show');
    }

    function enterNextQuestionMode() {
      waitingForClickToContinue = true;
      setInputEnabled(false);
      showCenterMessage();
      btnSubmit.textContent = '下一題';
    }

    function exitNextQuestionMode() {
      waitingForClickToContinue = false;
      hideCenterMessage();
      setInputEnabled(true);
      btnSubmit.textContent = '送出答案';
    }

    function getCurrentLevelLabel() {
      return LEVELS[currentLevelIndex].name;
    }

    function handleCorrectAnswer() {
      levelCorrectCount++;
      totalCorrect++;
      solvedIdioms.push(answer);

      const finishedAllLevels = (currentLevelIndex === LEVELS.length - 1 && levelCorrectCount >= 5);
      if (finishedAllLevels) {
        updateLevelUI();
        gameOver = true;
        showCenterMessage();
        btnSubmit.disabled = true;
        setInputEnabled(false);

        const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        const levelName = getCurrentLevelLabel();
        const extraLine = '<p style="margin-top:6px;color:#fbbf24;font-weight:700;">恭喜破關！</p>';
        const summary = `<p>成語能力：${levelName}</p><p>答題結果：共答對 ${totalCorrect} 題，正確率 ${accuracy}%</p>` + extraLine;

        openEndOverlay('成語能力總結', summary, true, true, false);
        return;
      }

      if (levelCorrectCount >= 5) {
        currentLevelIndex++;
        levelCorrectCount = 0;
        statusTextEl.textContent = `升級為「${LEVELS[currentLevelIndex].name}」！`;
        statusTextEl.classList.add('level-up');
      } else {
        statusTextEl.textContent = '';
        statusTextEl.classList.remove('level-up');
      }

      updateLevelUI();
      enterNextQuestionMode();
    }

    function submitRow() {
      if (gameOver) return;

      if (waitingForClickToContinue) {
        statusTextEl.textContent = '';
        statusTextEl.classList.remove('level-up');
        exitNextQuestionMode();
        newRound();
        return;
      }

      if (currentCol < COLS) {
        showToast('請先填滿四個字再送出。');
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        return;
      }

      const guess = boardState[currentRow].join('');
      colorRow(currentRow, guess);

      if (!answer) return;

      if (guess === answer) {
        totalQuestions++;
        handleCorrectAnswer();
        return;
      }

      currentRow++;
      if (currentRow >= ROWS) {
        totalQuestions++;
        gameOver = true;
        openEndOverlay('答案錯誤，遊戲結束', `<p>答案錯誤，遊戲結束。</p>`, false, false, true);
      } else {
        currentCol = 0;
        updateAttemptsText();
      }
    }

    function newRound() {
      answer = pickRandomIdiom();
      if (!answer) {
        statusTextEl.textContent = '題庫尚未載入完成，請稍後再試。';
        return;
      }
      currentRow = 0;
      currentCol = 0;
      gameOver = false;
      hideCenterMessage();
      statusTextEl.textContent = '';
      statusTextEl.classList.remove('level-up');
      initBoard();
      buildCharPool();
      updateAttemptsText();
      btnSubmit.disabled = false;
    }

    function restartGame() {
      currentLevelIndex = 0;
      levelCorrectCount = 0;
      solvedIdioms = [];
      totalQuestions = 0;
      totalCorrect = 0;
      closeEndOverlay();
      updateLevelUI();
      exitNextQuestionMode();
      newRound();
    }

    async function loadIdiomData() {
      try {
        const res = await fetch('data/wordle_game_data.json');
        if (!res.ok) throw new Error('載入題庫失敗');
        idiomData = await res.json();
        await loadRandomCharsFromFile();
        if (!ALL_CHARS) {
          getAllCharsPool();
        }
      } catch (e) {
        console.error(e);
        statusTextEl.textContent = '無法載入題庫，請確認 wordle_game_data.json 是否存在。';
      }
    }

    function generateCertificateImage() {
      return new Promise((resolve, reject) => {
        try {
          const canvas = shareCanvas;
          const ctx = canvas.getContext('2d');
          const w = canvas.width;
          const h = canvas.height;

          ctx.fillStyle = '#111827';
          ctx.fillRect(0, 0, w, h);

          const grad = ctx.createLinearGradient(0, 0, 0, h);
          grad.addColorStop(0, '#111827');
          grad.addColorStop(0.5, '#020617');
          grad.addColorStop(1, '#111827');
          ctx.fillStyle = grad;
          ctx.fillRect(16, 16, w - 32, h - 32);

          ctx.strokeStyle = '#fbbf24';
          ctx.lineWidth = 2.5;
          ctx.strokeRect(24, 24, w - 48, h - 48);

          ctx.strokeStyle = 'rgba(248, 113, 22, 0.8)';
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.strokeRect(32, 32, w - 64, h - 64);
          ctx.setLineDash([]);

          ctx.fillStyle = '#fbbf24';
          ctx.font = 'bold 28px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('成語 WORDLE 認證', w / 2, 70);

          ctx.fillStyle = '#e5e7eb';
          ctx.font = '16px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('成語能力證書', w / 2, 100);

          const levelName = getCurrentLevelLabel();
          const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

          ctx.textAlign = 'left';
          ctx.fillStyle = '#fbbf24';
          ctx.font = 'bold 20px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('達成等級：' + levelName, 60, 150);

          ctx.fillStyle = '#e5e7eb';
          ctx.font = '16px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('總答題數：' + totalQuestions + ' 題', 60, 190);
          ctx.fillText('答對題數：' + totalCorrect + ' 題', 60, 220);
          ctx.fillText('正確率：' + accuracy + '%', 60, 250);

          ctx.fillStyle = '#9ca3af';
          ctx.font = '13px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('（分享這張證書，讓朋友看看你的成語實力！）', 60, 285);

          const now = new Date();
          const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
          ctx.textAlign = 'right';
          ctx.fillStyle = '#6b7280';
          ctx.font = '12px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('日期：' + dateStr, w - 60, h - 50);

          ctx.textAlign = 'center';
          ctx.fillStyle = '#4b5563';
          ctx.font = '12px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
          ctx.fillText('成語 Wordle 小遊戲', w / 2, h - 28);

          const url = canvas.toDataURL('image/png');
          resolve(url);
        } catch (err) {
          reject(err);
        }
      });
    }

    function checkOrientation() {
      const isLandscape = window.matchMedia('(orientation: landscape)').matches || window.innerWidth > window.innerHeight;
      if (isLandscape) {
        orientationOverlay.classList.add('show');
      } else {
        orientationOverlay.classList.remove('show');
      }
    }

    btnSubmit.addEventListener('click', submitRow);
    btnUndo.addEventListener('click', undoChar);

    btnRetry.addEventListener('click', () => {
      restartGame();
      hideStartOverlay();
    });

    btnStartGame.addEventListener('click', () => {
      hideStartOverlay();
      if (!idiomData) {
        showToast('題庫載入中，請稍後再試。');
        return;
      }
      newRound();
    });

    btnStartRules.addEventListener('click', () => {
      showRulesOverlay();
    });

    btnOpenRules.addEventListener('click', () => {
      showRulesOverlay();
    });

    btnCloseRules.addEventListener('click', () => {
      hideRulesOverlay();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitRow();
      } else if (e.key === 'Backspace') {
        e.preventDefault();
        undoChar();
      }
    });

    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gestureend', function (e) {
      e.preventDefault();
    });

    window.addEventListener('orientationchange', checkOrientation);
    window.addEventListener('resize', checkOrientation);

    updateLevelUI();
    loadIdiomData();
    checkOrientation();
  </script>
</body>
</html>
