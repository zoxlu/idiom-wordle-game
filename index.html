<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>成語猜謎 </title>
  <style>
    :root {
      --bg-color: #020617;
      --board-bg: #020617;
      --tile-border: #e0e0e0;
      --tile-empty-bg: #020617;
      --tile-correct: #16a34a;
      --tile-present: #eab308;
      --tile-absent: #4b5563;
      --text-main: #f9fafb;
      --accent: #fb923c;
      --transition-fast: 0.15s ease-out;
      --tile-size: 64px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #1f2933, #020617 60%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .game-shell {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: #020617;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .top-bar {
      padding: 10px 14px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .title-group {
      display: flex;
      flex-direction: column;
    }

    .title {
      font-size: 18px;
      letter-spacing: 0.16em;
      font-weight: 700;
    }

    .subtitle {
      font-size: 11px;
      color: #cbd5f5;
      margin-top: 2px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .promotion-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 0 4px;
    }

    .promotion-message-top {
      font-size: 11px;
      line-height: 1.2;
      color: #fed7aa;
      text-align: center;
      white-space: nowrap;
    }

    .promotion-message-top strong {
      display: block;
      font-size: 12px;
      color: #fb923c;
    }

    button {
      cursor: pointer;
      border: none;
      outline: none;
      font-family: inherit;
    }

    .btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #0f172a;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    }

    .btn:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: #f97316;
      border-color: #ea580c;
      color: white;
      padding: 9px 16px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(248, 150, 69, 0.6), 0 0 16px rgba(248, 113, 22, 0.8);
    }

    .btn-ghost {
      background: transparent;
      border-color: #4b5563;
      color: #e5e7eb;
      padding-inline: 10px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 11px;
    }

    .btn-wide {
      min-width: 140px;
      justify-content: center;
    }

    .btn-undo-icon {
      font-size: 18px;
      line-height: 1;
    }

    .btn-icon-left {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .main-panel {
      flex: 1;
      padding: 10px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .board-wrapper {
      background: var(--board-bg);
      border-radius: 16px;
      padding: 12px 10px 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.85);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .status-text {
      min-height: 16px;
    }

    .status-text strong {
      color: #facc15;
    }

    .attempts {
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      font-weight: 600;
      color: #f97316;
    }

    .info-row-secondary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: #e5e7eb;
      gap: 6px;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid #4b5563;
      font-size: 12px;
      color: #e5e7eb;
    }

    .promotion-message {
      font-size: 12px;
      font-weight: 700;
      color: #fb923c;
      text-align: center;
      min-width: 0;
    }

    .promotion-message-line1 {
      display: block;
    }

    .promotion-message-line2 {
      display: block;
      margin-top: 2px;
    }

    .level-progress {
      font-size: 12px;
      color: #e5e7eb;
      text-align: right;
    }

    .level-progress strong {
      font-size: 14px;
      color: #fbbf24;
    }

    .board {
      display: grid;
      grid-template-rows: repeat(4, var(--tile-size));
      grid-template-columns: repeat(4, var(--tile-size));
      justify-content: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .tile {
      width: var(--tile-size);
      height: var(--tile-size);
      border-radius: 10px;
      border: 2px solid var(--tile-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: 700;
      background: var(--tile-empty-bg);
      color: var(--text-main);
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      transition: background 0.18s ease-out, border-color 0.18s ease-out, transform 0.08s ease-out;
    }

    .tile.filled {
      border-color: var(--accent);
    }

    .tile.correct {
      background: var(--tile-correct);
      border-color: var(--tile-correct);
      transform: scale(1.03);
    }

    .tile.present {
      background: var(--tile-present);
      border-color: var(--tile-present);
      transform: scale(1.03);
    }

    .tile.absent {
      background: var(--tile-absent);
      border-color: var(--tile-absent);
      color: #e5e7eb;
    }

    .tile.shake {
      animation: shake 0.22s ease-in-out;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    .pool-wrapper {
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px dashed #334155;
    }

    .pool-title {
      font-size: 12px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    .char-pool {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px 12px;
      justify-content: center;
    }

    .char-btn {
      padding: 8px 0;
      border-radius: 10px;
      border: 1px solid #9ca3af;
      background: radial-gradient(circle at top, #0f172a, #020617 70%);
      color: #f9fafb;
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), opacity var(--transition-fast);
      user-select: none;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .char-btn:active {
      transform: scale(0.96);
      box-shadow: none;
    }

    /* 選過，但不在答案裡的字：灰色且不可再選 */
    .char-btn.absent-global {
      background: #020617;
      border-color: #4b5563;
      color: #6b7280;
      cursor: default;
      box-shadow: none;
      transform: none;
      pointer-events: none;
    }

    /* 選過，且在答案裡的字：變成綠色，但仍可點擊 */
    .char-btn.used-correct {
      background: #14532d;
      border-color: #16a34a;
      color: #bbf7d0;
    }

    .char-btn.disabled {
      pointer-events: none;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .controls-left {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
    }

    .controls-right {
      display: flex;
      justify-content: flex-end;
      flex: 1;
    }

    .center-message {
      text-align: center;
      font-size: 20px;
      font-weight: 900;
      color: #f97316;
      margin-top: 6px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      pointer-events: none;
    }

    .center-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid #4b5563;
      font-size: 12px;
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 2px);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .overlay.show {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 16px;
      padding: 18px 16px 18px;
      border: 1px solid #1f2937;
      max-width: 340px;
      width: 92%;
      text-align: left;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.85);
    }

    .modal-title {
      font-size: 19px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }

    .modal-body {
      font-size: 14px;
      margin-bottom: 12px;
      color: #e5e7eb;
      line-height: 1.8;
    }

    .modal-body ul {
      padding-left: 18px;
      margin-top: 4px;
    }

    .modal-body li + li {
      margin-top: 4px;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .highlight-correct { color: #4ade80; font-weight: 600; }
    .highlight-present { color: #facc15; font-weight: 600; }

    /* 結束視窗統計資訊 */
    .end-stats {
      font-size: 14px;
      line-height: 1.8;
      margin-top: 6px;
    }

    .end-stats-row {
      display: flex;
      justify-content: space-between;
      margin-top: 3px;
    }

    /* 橫向模式提示（僅手機） */
    .orientation-warning {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15,23,42,0.95);
      color: #fbbf24;
      border-top: 1px solid #4b5563;
      padding: 8px 12px;
      font-size: 12px;
      text-align: center;
      z-index: 50;
      display: none;
      white-space: nowrap;
    }

    .orientation-warning.show {
      display: block;
    }

    /* 證書 canvas 容器 */
    .certificate-wrapper {
      margin-top: 10px;
      text-align: center;
    }

    .certificate-canvas {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid #4b5563;
      box-shadow: 0 10px 25px rgba(0,0,0,0.7);
    }

    @media (max-width: 400px) {
      :root {
        --tile-size: 56px;
      }
      .title { font-size: 16px; }
      .char-btn { font-size: 20px; min-height: 52px; }
      .main-panel { padding-inline: 8px; }
      .promotion-message-top { font-size: 10px; }
      .promotion-message-top strong { font-size: 11px; }
    }

    @media (max-height: 640px) {
      .board-wrapper {
        padding-block: 10px;
      }
      .pool-wrapper {
        margin-top: 4px;
      }
      .char-btn {
        min-height: 50px;
      }
    }
  </style>
</head>
<body>
  
  <!-- ============================= -->
  <!-- Canvas Certificate Generator -->
  <!-- ============================= -->

   <!--<canvas id="certificateCanvas" style="display:none"></canvas>-->

  <script>
    function generateCertificate(result) {
      const canvas = document.getElementById('certificate-canvas');
      const ctx = canvas.getContext('2d');

      const img = new Image();
      img.src = './data/certificate_template.jpg';

      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        //ctx.fillStyle = '#f5f1e8';
        //ctx.font = '36px serif';
        ctx.fillStyle = '#E8D8B0';          
        //ctx.font ='32px sans-serif';
        ctx.font = '32px "Noto Serif TC", sans-serif';          
        ctx.textAlign = 'left';
        //ctx.textBaseline = 'middle';  


          

        // === 精準座標（依照 template 實測） ===
        ctx.fillText(result.level, 270, 650);           // 等級
        ctx.fillText(result.correctCount, 270, 720);   // 答對題目
        ctx.fillText(result.accuracy + '%', 650,720); // 正確率
        ctx.fillText(result.time, 290, 800);           // 總時間
        ctx.fillText(result.date, 560, 800);           // 日期


        document.getElementById('certificate-wrapper').style.display = 'block';
        // 下載
        //const link = document.createElement('a');
        //link.download = 'idiom_wordle_certificate.jpg';
        //link.href = canvas.toDataURL('image/jpg');
        //link.click();
        window.__certificateReady = true;          
      };
        
      if (!window.__certificateReady) {
        showToast('證書尚未完成，請稍候');
        return;
        }  
    }

    // === 遊戲結束時呼叫（接原本邏輯） ===
   /*   
    function onGameFinished() {
      const gameResult = {
        level: currentLevel || '普羅大眾',
        correctCount: `${correctAnswers} 題`,
        accuracy: Math.round((correctAnswers / totalQuestions) * 100),
        time: `${Math.floor(totalTimeSeconds / 60)} 分 ${totalTimeSeconds % 60} 秒`,
        date: new Date().toLocaleDateString('zh-TW')
      };

      generateCertificate(gameResult);
    }     
    */
  </script>
    
  <div class="toast" id="toast"></div>

  <!-- 遊戲結束視窗 -->
  <div class="overlay" id="end-overlay">
    <div class="modal">
      <div class="modal-title" id="end-title"></div>
      <div class="modal-body" id="end-body"></div>
      <div class="end-stats" id="end-stats"></div>
      <div class="certificate-wrapper" id="certificate-wrapper" style="display:none;">
        <canvas id="certificate-canvas" class="certificate-canvas" width="600" height="800"></canvas>
      </div>
      <div style="height: 8px;"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost btn-wide btn-icon-left" id="btn-share">
          <span style="font-size:14px;">⇪</span>
          <span>分享</span>
        </button>
        <button class="btn btn-primary btn-wide" id="btn-retry">再玩一次</button>
      </div>
    </div>
  </div>

  <!-- 開場說明彈窗 -->
  <div class="overlay show" id="start-overlay">
    <div class="modal">
      <div class="modal-title">成語猜謎</div>
      <div class="modal-body">
        <p>四字成語版 Wordle，適合在手機上動動腦的猜成語小遊戲。</p>
        <ul>
          <li>從下方 16 個字中選出 <strong>4 個</strong>，依序填入上方空格後按「送出答案」。</li>
          <li><span class="highlight-correct">綠色</span>：字和<strong>位置</strong>都正確；<span class="highlight-present">土黃色</span>：字在成語中但<strong>位置不對</strong>；灰色：不在答案中。</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost btn-small" id="btn-start-rules">遊戲規則</button>
        <button class="btn btn-primary btn-wide" id="btn-start-game">開始遊戲</button>
      </div>
    </div>
  </div>

  <!-- 遊戲規則彈窗 -->
  <div class="overlay" id="rules-overlay">
    <div class="modal">
      <div class="modal-title">遊戲規則</div>
      <div class="modal-body">
        <p>每一題的目標是猜出一個四字成語：</p>
        <ul>
          <li>從畫面下方 16 個字中選出 <strong>4 個</strong>，依順序填進上方 4 個格子。</li>
          <li>填滿後按「送出答案」，系統會用顏色給你提示。</li>
          <li><span class="highlight-correct">綠色</span>：字和<strong>位置</strong>都正確。</li>
          <li><span class="highlight-present">土黃色</span>：字有出現在答案中，但<strong>位置不對</strong>。</li>
          <li>灰色：這個字沒有出現在答案中。</li>
          <li>每題有四次猜謎機會。</li>
        </ul>
        <p style="margin-top:6px;">連續答對多題可以升級，挑戰更困難的成語！</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost btn-wide" id="btn-close-rules">關閉</button>
      </div>
    </div>
  </div>

  <div class="game-shell">
    <header class="top-bar">
      <div class="title-group">
        <div class="title">成語猜謎</div>
        <div class="subtitle">四字成語版 Wordle</div>
      </div>
      <div class="promotion-wrapper">
        <div class="promotion-message-top" id="promotion-message-top" style="display:none;">
          <span class="promotion-message-line1">恭喜你升級至：</span>
          <strong class="promotion-message-line2" id="promotion-message-top-level"></strong>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn btn-small btn-ghost" id="btn-open-rules">遊戲規則</button>
      </div>
    </header>

    <main class="main-panel">
      <section class="board-wrapper" id="board-wrapper">
        <div class="info-row">
          <div class="status-text" id="status-text"></div>
          <div class="attempts" id="attempts-text"></div>
        </div>

        <div class="info-row-secondary">
          <div>
            等級：
            <span class="level-badge" id="level-badge">小學生</span>
          </div>
          <div class="promotion-message" id="promotion-message"></div>
          <div class="level-progress">本級已答對 <strong id="level-correct">0</strong> 題</div>
        </div>

        <div class="board" id="board"></div>
        <div class="center-message" id="center-message">正確答案</div>

        <div class="pool-wrapper">
          <div class="pool-title">請點選下方文字，依順序填入上方空格：</div>
          <div class="char-pool" id="char-pool"></div>
        </div>

        <div class="controls">
          <div class="controls-left">
            <button class="btn btn-small btn-ghost" id="btn-undo"><span class="btn-undo-icon">⌫</span> 退回一格</button>
          </div>
          <div class="controls-right">
            <button class="btn btn-primary" id="btn-submit">送出答案</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="orientation-warning" id="orientation-warning">遊戲顯示不支援橫向螢幕，請將手機轉回直立螢幕</div>

  <script>
    const LEVELS = [
      { key: 'elementary', name: '小學生' },
      { key: 'general', name: '普羅大眾' },
      { key: 'teacher', name: '國文老師' },
      { key: 'professor', name: '中文系教授' }
    ];

    const ROWS = 4;
    const COLS = 4;

    const boardEl = document.getElementById('board');
    const poolEl = document.getElementById('char-pool');
    const statusTextEl = document.getElementById('status-text');
    const attemptsTextEl = document.getElementById('attempts-text');
    const toastEl = document.getElementById('toast');
    const levelBadgeEl = document.getElementById('level-badge');
    const levelCorrectEl = document.getElementById('level-correct');
    const promotionMessageEl = document.getElementById('promotion-message');
    const promotionMessageTopEl = document.getElementById('promotion-message-top');
    const promotionMessageTopLevelEl = document.getElementById('promotion-message-top-level');
    const endOverlayEl = document.getElementById('end-overlay');
    const endTitleEl = document.getElementById('end-title');
    const endBodyEl = document.getElementById('end-body');
    const endStatsEl = document.getElementById('end-stats');
    const certificateWrapperEl = document.getElementById('certificate-wrapper');
    const certificateCanvas = document.getElementById('certificate-canvas');
    const boardWrapperEl = document.getElementById('board-wrapper');
    const centerMessageEl = document.getElementById('center-message');

    const startOverlayEl = document.getElementById('start-overlay');
    const rulesOverlayEl = document.getElementById('rules-overlay');
    const btnStartGame = document.getElementById('btn-start-game');
    const btnStartRules = document.getElementById('btn-start-rules');
    const btnOpenRules = document.getElementById('btn-open-rules');
    const btnCloseRules = document.getElementById('btn-close-rules');

    const btnSubmit = document.getElementById('btn-submit');
    const btnUndo = document.getElementById('btn-undo');
    const btnRetry = document.getElementById('btn-retry');
    const btnShare = document.getElementById('btn-share');

    const orientationWarningEl = document.getElementById('orientation-warning');

    let ALL_CHARS = '';
    let idiomData = null;

    let answer = '';
    let currentRow = 0;
    let currentCol = 0;
    let boardState = [];
    let gameOver = false;
    let waitingForClickToContinue = false;

    let currentLevelIndex = 0;
    let levelCorrectCount = 0;
    let solvedIdioms = [];

    // 統計資料
    let totalQuestions = 0;
    let totalAttempts = 0;
    let gameStartTime = null;
    let gameEndTime = null;

    // 證書背景暫存
    let lastSolvedBoardSnapshot = null;
    let certificateBgImage = null;

    function showToast(msg, duration = 1500) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, duration);
    }

    function openEndOverlay(title, body) {
      endTitleEl.textContent = title;
      endBodyEl.textContent = body;
      endOverlayEl.classList.add('show');
    }

    function closeEndOverlay() {
      endOverlayEl.classList.remove('show');
    }

    function showStartOverlay() {
      startOverlayEl.classList.add('show');
    }

    function hideStartOverlay() {
      startOverlayEl.classList.remove('show');
    }

    function showRulesOverlay() {
      rulesOverlayEl.classList.add('show');
    }

    function hideRulesOverlay() {
      rulesOverlayEl.classList.remove('show');
    }

    function initBoard() {
      boardEl.innerHTML = '';
      boardState = Array.from({ length: ROWS }, () => Array(COLS).fill(''));
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const div = document.createElement('div');
          div.className = 'tile';
          div.dataset.row = r;
          div.dataset.col = c;
          boardEl.appendChild(div);
        }
      }
    }

    function updateAttemptsText() {
      attemptsTextEl.textContent = '';
    }

    function updateLevelUI() {
      levelBadgeEl.textContent = LEVELS[currentLevelIndex].name;
      levelCorrectEl.textContent = levelCorrectCount;
    }

    function getCurrentLevelBucket() {
      if (!idiomData || !idiomData.levels) return [];
      const levelKey = LEVELS[currentLevelIndex].key;
      const bucket = idiomData.levels[levelKey] || [];
      return bucket;
    }

    function pickRandomIdiom() {
      const bucket = getCurrentLevelBucket();
      if (!bucket.length) {
        console.warn('題庫為空或尚未載入，無法選題');
        return '';
      }
      const usedSet = new Set(solvedIdioms);
      const available = bucket.filter(i => !usedSet.has(i));
      const pool = available.length > 0 ? available : bucket;
      const idx = Math.floor(Math.random() * pool.length);
      return pool[idx];
    }

    function getAllCharsPool() {
      if (ALL_CHARS && ALL_CHARS.length) return ALL_CHARS;
      if (!idiomData || !idiomData.levels) return '';
      const all = [];
      Object.values(idiomData.levels).forEach(list => {
        list.forEach(idiom => {
          idiom.split('').forEach(ch => all.push(ch));
        });
      });
      ALL_CHARS = Array.from(new Set(all)).join('');
      return ALL_CHARS;
    }

    async function loadRandomCharsFromFile() {
      try {
        const res = await fetch('random.json');
        if (!res.ok) throw new Error('載入 random.json 失敗');
        const data = await res.json();
        if (Array.isArray(data.randomChars)) {
          ALL_CHARS = Array.from(new Set(data.randomChars.join(''))).join('');
        }
      } catch (e) {
        console.warn('使用題庫自帶字庫作為備援方案：', e);
        getAllCharsPool();
      }
    }

    function getRandomChars(n, excludeChars) {
      const pool = Array.from(new Set(ALL_CHARS.split('').filter(ch => !excludeChars.includes(ch))));
      const result = [];
      for (let i = 0; i < n && pool.length > 0; i++) {
        const idx = Math.floor(Math.random() * pool.length);
        result.push(pool[idx]);
        pool.splice(idx, 1);
      }
      return result;
    }

    function buildCharPool() {
      poolEl.innerHTML = '';
      const ansChars = answer.split('');
      const randomChars = getRandomChars(12, ansChars);
      let chars = ansChars.concat(randomChars);
      for (let i = chars.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [chars[i], chars[j]] = [chars[j], chars[i]];
      }
      chars.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.className = 'char-btn';
        btn.textContent = ch;
        btn.dataset.char = ch;
        btn.dataset.index = idx;
        btn.addEventListener('click', () => onCharClick(ch, btn));
        poolEl.appendChild(btn);
      });
    }

    function setInputEnabled(enabled) {
      const charButtons = poolEl.querySelectorAll('.char-btn');
      charButtons.forEach(btn => {
        if (enabled) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
      btnUndo.disabled = !enabled;
    }

    function getCharButtonsByChar(ch) {
      return Array.from(poolEl.querySelectorAll(`.char-btn[data-char="${ch}"]`));
    }

    // 更新選字區狀態：
    // - 選過且不在答案裡的字 => absent-global（灰色不可選）
    // - 選過且在答案裡的字   => used-correct（綠色但可再選）
    function markPoolCharsAfterGuess(guess) {
      const answerChars = answer.split('');
      const uniqueGuess = Array.from(new Set(guess.split('')));
      uniqueGuess.forEach(ch => {
        const buttons = getCharButtonsByChar(ch);
        if (!buttons.length) return;
        if (!answerChars.includes(ch)) {
          buttons.forEach(btn => {
            btn.classList.add('absent-global');
            btn.classList.remove('used-correct');
          });
        } else {
          buttons.forEach(btn => {
            if (!btn.classList.contains('absent-global')) {
              btn.classList.add('used-correct');
            }
          });
        }
      });
    }

    function onCharClick(ch, btn) {
      if (gameOver || waitingForClickToContinue) return;
      if (btn.classList.contains('disabled') || btn.classList.contains('absent-global')) return;
      if (currentCol >= COLS) {
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        showToast('本列已填滿 4 個字，請先送出或刪除。');
        return;
      }
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = ch;
      tile.classList.add('filled');
      boardState[currentRow][currentCol] = ch;
      currentCol++;
    }

    function getRowTiles(row) {
      return Array.from(boardEl.querySelectorAll(`.tile[data-row="${row}"]`));
    }

    function undoChar() {
      if (gameOver || waitingForClickToContinue) return;
      if (currentCol === 0) {
        showToast('本列沒有可以刪除的字。');
        return;
      }
      currentCol--;
      const rowTiles = getRowTiles(currentRow);
      const tile = rowTiles[currentCol];
      tile.textContent = '';
      tile.classList.remove('filled');
      boardState[currentRow][currentCol] = '';
    }

    function colorRow(row, guess) {
      const tiles = getRowTiles(row);
      const answerChars = answer.split('');
      const result = Array(COLS).fill('absent');

      const remaining = {};
      answerChars.forEach((ch, i) => {
        if (guess[i] === ch) {
          result[i] = 'correct';
        } else {
          remaining[ch] = (remaining[ch] || 0) + 1;
        }
      });

      for (let i = 0; i < COLS; i++) {
        if (result[i] === 'correct') continue;
        const ch = guess[i];
        if (remaining[ch] > 0) {
          result[i] = 'present';
          remaining[ch]--;
        }
      }

      tiles.forEach((tile, i) => {
        tile.classList.remove('filled', 'correct', 'present', 'absent');
        tile.classList.add(result[i]);
      });
    }

    function showCenterMessage() {
      centerMessageEl.classList.add('show');
    }

    function hideCenterMessage() {
      centerMessageEl.classList.remove('show');
    }

    function enterNextQuestionMode() {
      waitingForClickToContinue = true;
      setInputEnabled(false);
      showCenterMessage();
      btnSubmit.textContent = '下一題';
    }

    function exitNextQuestionMode() {
      waitingForClickToContinue = false;
      hideCenterMessage();
      setInputEnabled(true);
      btnSubmit.textContent = '送出答案';
      promotionMessageEl.textContent = '';
    }

    function getCurrentLevelLabel() {
      return LEVELS[currentLevelIndex].name;
    }

    function getAbilityLabelByLevelIndex(idx) {
      return LEVELS[idx].name;
    }

    function formatDuration(ms) {
      const totalSec = Math.floor(ms / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      if (min === 0) return sec + ' 秒';
      return min + ' 分 ' + sec + ' 秒';
    }

    function handleGameEnd(success) {
      gameOver = true;
      gameEndTime = Date.now();
      const durationMs = gameStartTime ? (gameEndTime - gameStartTime) : 0;
      const percent = totalAttempts ? Math.round((totalQuestions / totalAttempts) * 100) : 0;
      const ability = getAbilityLabelByLevelIndex(currentLevelIndex);

      const title = success ? '恭喜破關，你是成語達人' : '答案錯誤，遊戲結束';
      const body = '成語能力：' + ability;
      const statsHtml = `
        <div>答對題目：${totalQuestions} 題</div>
        <div>答題正確率：${percent}%</div>
        <div>總答題時間：${formatDuration(durationMs)}</div>
      `;
        
      // --- certificate related --- 
        
      const gameResult = {
        level: ability,
        correctCount: `${totalQuestions} 題`,
        accuracy:percent,
        //time: `${Math.floor(totalTimeSeconds / 60)} 分 ${totalTimeSeconds % 60} 秒`,
        //time: durationMs,
        time: `${Math.floor(durationMs / 60000)} 分 ${ Math.floor(durationMs/1000) % 60} 秒`,  
        date: new Date().toLocaleDateString('zh-TW')
      };
      
      generateCertificate(gameResult);
      // --- certificate related ---  
        
      //endStatsEl.innerHTML = statsHtml;
      //drawCertificate();
      //openEndOverlay(title, body);
      openEndOverlay(title);  
    }
/*
    // 儲存最後一題成功時的盤面，作為證書背景
    function snapshotBoard() {
      try {
        const rect = boardWrapperEl.getBoundingClientRect();
        lastSolvedBoardSnapshot = {
          width: rect.width,
          height: rect.height,
          bgColor: getComputedStyle(boardWrapperEl).backgroundColor
        };
      } catch (e) {
        console.warn('snapshotBoard failed', e);
      }
    }
*/    
/*
    function ensureCertificateBgLoaded() {
      return new Promise(resolve => {
        if (certificateBgImage && certificateBgImage.complete) {
          resolve(certificateBgImage);
          return;
        }
        if (!certificateBgImage) {
          certificateBgImage = new Image();
          certificateBgImage.src = './data/certificate_bg.png';
          certificateBgImage.onload = () => resolve(certificateBgImage);
          certificateBgImage.onerror = () => resolve(null);
        } else {
          certificateBgImage.onload = () => resolve(certificateBgImage);
          certificateBgImage.onerror = () => resolve(null);
        }
      });
    }
*/    
/*
    function drawCertificateTextLayer(ctx, w, h) {
      const percent = totalAttempts ? Math.round((totalQuestions / totalAttempts) * 100) : 0;
      const durationMs = gameStartTime && gameEndTime ? (gameEndTime - gameStartTime) : 0;
      const ability = getAbilityLabelByLevelIndex(currentLevelIndex);

      // 主標題
      ctx.fillStyle = '#ffffff';
      ctx.font = '700 34px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('成語 WORDLE 證書', w / 2, h * 0.23);

      // 等級與數據
      ctx.textAlign = 'left';
      const leftX = w * 0.18;
      let y = h * 0.30;
      const lh = 34;

      ctx.font = '600 20px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      ctx.fillStyle = '#bef264';
      ctx.fillText('等級：' + ability, leftX, y);
      y += lh;
      ctx.fillStyle = '#fde68a';
      ctx.fillText('答對題目：' + totalQuestions + ' 題', leftX, y);
      y += lh;
      ctx.fillText('答題正確率：' + percent + '%', leftX, y);
      y += lh;
      ctx.fillText('總答題時間：' + formatDuration(durationMs), leftX, y);

      // 日期
      const date = new Date();
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const dateText = `${yyyy} / ${mm} / ${dd}`;
      y += lh;
      ctx.fillStyle = '#e5e7eb';
      ctx.fillText('今天日期：' + dateText, leftX, y);

      // 再接再厲標語
      const badgeY = h * 0.16;
      const badgeW = w * 0.46;
      const badgeH = 40;
      const badgeX = (w - badgeW) / 2;

      ctx.save();
      const grad = ctx.createLinearGradient(badgeX, badgeY, badgeX + badgeW, badgeY + badgeH);
      grad.addColorStop(0, '#34d399');
      grad.addColorStop(1, '#4ade80');
      ctx.fillStyle = grad;
      ctx.strokeStyle = 'rgba(15,23,42,0.7)';
      ctx.lineWidth = 2;
      roundRectPath(ctx, badgeX, badgeY, badgeW, badgeH, 999);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = '#022c22';
      ctx.font = '700 20px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('再接再厲', w / 2, badgeY + badgeH / 2 + 7);
      ctx.restore();

      // 網址置中最下方
      ctx.textAlign = 'center';
      ctx.font = '500 16px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      ctx.fillStyle = '#9ca3af';
      ctx.fillText('https://zoxlu.github.io/idiom-wordle-game', w / 2, h - 40);
    }
*/
    function roundRectPath(ctx, x, y, w, h, r) {
      const radius = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + w - radius, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
      ctx.lineTo(x + w, y + h - radius);
      ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
      ctx.lineTo(x + radius, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }
/*
    async function drawCertificate() {
      if (!certificateCanvas) return;
      const ctx = certificateCanvas.getContext('2d');
      const w = certificateCanvas.width;
      const h = certificateCanvas.height;

      ctx.clearRect(0, 0, w, h);

      const img = await ensureCertificateBgLoaded();
      if (img) {
        // 背景圖等比例覆蓋
        const imgRatio = img.width / img.height;
        const canvasRatio = w / h;
        let drawW, drawH, offsetX, offsetY;
        if (imgRatio > canvasRatio) {
          drawH = h;
          drawW = imgRatio * drawH;
          offsetX = (w - drawW) / 2;
          offsetY = 0;
        } else {
          drawW = w;
          drawH = drawW / imgRatio;
          offsetX = 0;
          offsetY = (h - drawH) / 2;
        }
        ctx.drawImage(img, offsetX, offsetY, drawW, drawH);

        // 暗化 + 聚焦
        const gradient = ctx.createRadialGradient(
          w / 2,
          h * 0.32,
          h * 0.15,
          w / 2,
          h * 0.35,
          h * 0.7
        );
        gradient.addColorStop(0, 'rgba(0,0,0,0.35)');
        gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, w, h);
      } else {
        // 後備純色背景
        const bgGradient = ctx.createLinearGradient(0, 0, 0, h);
        bgGradient.addColorStop(0, '#020617');
        bgGradient.addColorStop(0.4, '#0f172a');
        bgGradient.addColorStop(1, '#020617');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, w, h);
      }

      // 中間偏上文字區白色卡片
      const cardW = w * 0.74;
      const cardH = h * 0.40;
      const cardX = (w - cardW) / 2;
      const cardY = h * 0.22;

      ctx.save();
      ctx.shadowColor = 'rgba(15,23,42,0.85)';
      ctx.shadowBlur = 24;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 18;
      ctx.fillStyle = 'rgba(15,23,42,0.88)';
      ctx.strokeStyle = 'rgba(148,163,184,0.5)';
      ctx.lineWidth = 2;
      roundRectPath(ctx, cardX, cardY, cardW, cardH, 24);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      // 內層淡邊
      ctx.save();
      ctx.strokeStyle = 'rgba(248,250,252,0.06)';
      ctx.lineWidth = 1;
      roundRectPath(ctx, cardX + 10, cardY + 9, cardW - 20, cardH - 18, 18);
      ctx.stroke();
      ctx.restore();

      // 在卡片上畫文字資訊
      ctx.save();
      ctx.beginPath();
      roundRectPath(ctx, cardX, cardY, cardW, cardH, 24);
      ctx.clip();
      drawCertificateTextLayer(ctx, w, h);
      ctx.restore();

      certificateWrapperEl.style.display = 'block';
    }
*/      
      
    function downloadCertificate() {
      const canvas = document.getElementById('certificate-canvas');
    
      if (!canvas) {
        alert('證書尚未產生');
        return;
      }
    
      const dataUrl = canvas.toDataURL('image/jpg');
    
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = '成語Wordle證書.jpg';
    
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
/*
    async function shareCertificate() {
      try {
        //await generateCertificate(gameResult);         
        //await drawCertificate();
        //if (!certificateCanvas) return;
          
 
  
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        const file = new File([blob], 'chengyu-wordle-certificate.jpg', { type: 'image/jpg' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: '成語 Wordle 證書',
            text: '來看看我的成語 Wordle 成績！',
            files: [file]
          });
        } else {
          const link = document.createElement('a');
          link.href = dataUrl;
          link.download = 'chengyu-wordle-certificate.jpg';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showToast('已產生證書圖片，可儲存到相簿或分享。', 2000);

        
      } catch (e) {
        console.error(e);
        showToast('分享失敗，請稍後再試。', 2000);
      }
     
    }
*/      

    function handleCorrectAnswer() {
      levelCorrectCount++;
      solvedIdioms.push(answer);
      totalQuestions++;

      const finishedAllLevels = (currentLevelIndex === LEVELS.length - 1 && levelCorrectCount >= 5);
      if (finishedAllLevels) {
        updateLevelUI();
        statusTextEl.textContent = '';
        snapshotBoard();
        handleGameEnd(true);
        btnSubmit.disabled = true;
        setInputEnabled(false);
        return;
      }

        if (levelCorrectCount >= 5) {
        currentLevelIndex++;
        levelCorrectCount = 0;
        const newLevelName = LEVELS[currentLevelIndex].name;
        //promotionMessageEl.innerHTML = '<span class="promotion-message-line1">恭喜你升級至：</span><span class="promotion-message-line2">' + newLevelName + '</span>';
        promotionMessageTopLevelEl.textContent = newLevelName;
        promotionMessageTopEl.style.display = 'block';
      }

      updateLevelUI();
      statusTextEl.textContent = '';
      snapshotBoard();
      enterNextQuestionMode();
    }

    function submitRow() {
      if (gameOver) return;

      if (waitingForClickToContinue) {
        exitNextQuestionMode();
        newRound();
        return;
      }

      if (currentCol < COLS) {
        showToast('請先填滿四個字再送出。');
        const rowTiles = getRowTiles(currentRow);
        rowTiles.forEach(t => t.classList.add('shake'));
        setTimeout(() => rowTiles.forEach(t => t.classList.remove('shake')), 220);
        return;
      }

      const guess = boardState[currentRow].join('');
      colorRow(currentRow, guess);
      markPoolCharsAfterGuess(guess);
      totalAttempts++;

      if (guess === answer) {
        handleCorrectAnswer();
        return;
      }

      currentRow++;
      if (currentRow >= ROWS) {
        statusTextEl.textContent = `Game Over，正確答案是：${answer}`;
        handleGameEnd(false);
      } else {
        currentCol = 0;
        updateAttemptsText();
      }
    }

    function newRound() {
      answer = pickRandomIdiom();
      if (!answer) {
        statusTextEl.textContent = '題庫尚未載入完成，請稍後再試。';
        return;
      }
      currentRow = 0;
      currentCol = 0;
      gameOver = false;
      hideCenterMessage();
      statusTextEl.textContent = '';
      initBoard();
      buildCharPool();
      updateAttemptsText();
      btnSubmit.disabled = false;
      //remove promotmessage 
      promotionMessageTopEl.style.display = 'none';        
    }

    function restartGame() {
      currentLevelIndex = 0;
      levelCorrectCount = 0;
      solvedIdioms = [];
      totalQuestions = 0;
      totalAttempts = 0;
      gameStartTime = Date.now();
      gameEndTime = null;
      lastSolvedBoardSnapshot = null;
      promotionMessageEl.textContent = '';
      promotionMessageTopEl.style.display = 'none';
      closeEndOverlay();
      updateLevelUI();
      exitNextQuestionMode();
      newRound();
    }

    async function loadIdiomData() {
      try {
        const res = await fetch('data/wordle_game_data.json');
        if (!res.ok) throw new Error('載入題庫失敗');
        idiomData = await res.json();
        await loadRandomCharsFromFile();
        if (!ALL_CHARS) {
          getAllCharsPool();
        }
      } catch (e) {
        console.error(e);
        statusTextEl.textContent = '無法載入題庫，請確認 wordle_game_data.json 是否存在。';
      }
    }

    function handleOrientationChange() {
      const isMobile = /Mobi|Android/i.test(navigator.userAgent);
      if (!isMobile) {
        orientationWarningEl.classList.remove('show');
        return;
      }
      const isLandscape = window.matchMedia('(orientation: landscape)').matches || window.innerWidth > window.innerHeight;
      if (isLandscape) {
        orientationWarningEl.classList.add('show');
      } else {
        orientationWarningEl.classList.remove('show');
      }
    }
      

    btnSubmit.addEventListener('click', submitRow);
    btnUndo.addEventListener('click', undoChar);
    btnRetry.addEventListener('click', () => {
      restartGame();
      hideStartOverlay();
    });
    //btnShare.addEventListener('click', shareCertificate);
    btnShare.addEventListener('click', downloadCertificate);
      
    btnStartGame.addEventListener('click', () => {
      hideStartOverlay();
      if (!idiomData) {
        showToast('題庫載入中，請稍後再試。');
        return;
      }
      gameStartTime = Date.now();
      newRound();
    });

    btnStartRules.addEventListener('click', () => {
      showRulesOverlay();
    });

    btnOpenRules.addEventListener('click', () => {
      showRulesOverlay();
    });

    btnCloseRules.addEventListener('click', () => {
      hideRulesOverlay();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitRow();
      } else if (e.key === 'Backspace') {
        e.preventDefault();
        undoChar();
      }
    });

    window.addEventListener('orientationchange', handleOrientationChange);
    window.addEventListener('resize', handleOrientationChange);

    updateLevelUI();
    loadIdiomData();
    handleOrientationChange();

       
  </script>
</body>
</html>
